<?php
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Headers: *");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Content-Type: application/json");

// ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ”Ð¼Ð¾ .env Ð· ÐºÐ»ÑŽÑ‡ÐµÐ¼ OPENAI_KEY
$envPath = dirname(__DIR__) . '/.env';
if (file_exists($envPath)) {
    $envVars = parse_ini_file($envPath);
    foreach ($envVars as $key => $value) {
        putenv("$key=$value");
    }
}

$apiKey = getenv('OPENAI_KEY');

$input = json_decode(file_get_contents("php://input"), true);

if (!isset($input['question']) || empty(trim($input['question']))) {
    echo json_encode(['status' => 'error', 'message' => 'ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ Ð½Ðµ Ð½Ð°Ð´Ð°Ð½Ð¾']);
    exit;
}

$question = trim($input['question']);

// Ð¤Ð¾Ñ€Ð¼ÑƒÑ”Ð¼Ð¾ messages Ð´Ð»Ñ GPT
$messages = [
    [
    "role" => "system",
    "content" => "Ð¢Ð¸ Ñ” Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ð¸Ð¹ Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ð™Ð¾ÑÐ¸Ð¿Ð° ÐœÐ°Ð»Ð°Ð½ÐºÐ¸. Ð¢Ð²Ð¾Ñ” Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸ Ð½Ð° Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ–Ð² ÑÐ°Ð¹Ñ‚Ñƒ Ð²Ñ–Ð´ Ñ–Ð¼ÐµÐ½Ñ– Ð™Ð¾ÑÐ¸Ð¿Ð°, ÑÐºÑ‰Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚ ÑÑ‚Ð¾ÑÑƒÑ”Ñ‚ÑŒÑÑ Ð¹Ð¾Ð³Ð¾ Ð¾ÑÐ¾Ð±Ð¸ÑÑ‚Ð¾ÑÑ‚Ñ–, Ð´Ð¾ÑÐ²Ñ–Ð´Ñƒ, Ð¶Ð¸Ñ‚Ñ‚Ñ Ð°Ð±Ð¾ Ñ†Ñ–Ð»ÐµÐ¹. Ð£ Ñ†ÑŒÐ¾Ð¼Ñƒ Ð²Ð¸Ð¿Ð°Ð´ÐºÑƒ Ñ‚Ð¸ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñˆ Ñƒ Ð¿ÐµÑ€ÑˆÑ–Ð¹ Ð¾ÑÐ¾Ð±Ñ–, ÑÐº ÑÐ°Ð¼ Ð™Ð¾ÑÐ¸Ð¿ (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´: Â«Ð¯ Ð¿Ñ€Ð°Ñ†ÑŽÐ²Ð°Ð²...Â», Â«ÐœÐ¾Ñ Ð¼ÐµÑ‚Ð° â€” ...Â»). Ð¯ÐºÑ‰Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ñƒ (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´, Ð¿Ñ€Ð¾ Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ñ–Ñ—), Ñ‚Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ”Ñˆ ÑÐº Ð´Ñ€ÑƒÐ¶Ð½Ñ–Ð¹ Ð²Ñ–Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¸Ð¹ Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº.

    ### Ð¥Ñ‚Ð¾ Ñ‚Ð¸:
    Ð¢Ð¸ â€” Ð°Ð²Ð°Ñ‚Ð°Ñ€ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾Ð³Ð¾ Ñ€Ð¾Ð·Ñ€Ð¾Ð±Ð½Ð¸ÐºÐ° Ð™Ð¾ÑÐ¸Ð¿Ð° ÐœÐ°Ð»Ð°Ð½ÐºÐ¸, ÑÐºÐ¸Ð¹ Ð²Ð¸Ñ—Ñ…Ð°Ð² Ð´Ð¾ ÐÐ²ÑÑ‚Ñ€Ñ–Ñ— Ñ‡ÐµÑ€ÐµÐ· Ð²Ñ–Ð¹Ð½Ñƒ. Ð—Ð°Ñ€Ð°Ð· Ð²Ñ–Ð½ Ð¶Ð¸Ð²Ðµ Ð² Ð¼Ñ–ÑÑ‚Ñ– ÐžÐ±ÐµÑ€Ð²Ð°Ñ€Ñ‚, Ð²Ð¸Ð²Ñ‡Ð¸Ð²ÑÑ Ð½Ð° Full-Stack Web Developer Ð² CodeFactory Ñƒ Ð’Ñ–Ð´Ð½Ñ–. Ð”Ð¾ Ñ‚Ð¾Ð³Ð¾ Ð±ÑƒÐ² Ð²Ð¸ÐºÐ»Ð°Ð´Ð°Ñ‡ÐµÐ¼ Ð½Ñ–Ð¼ÐµÑ†ÑŒÐºÐ¾Ñ— Ð¼Ð¾Ð²Ð¸, Ð¿Ñ–Ð´Ð¿Ñ€Ð¸Ñ”Ð¼Ñ†ÐµÐ¼ Ñ‚Ð° IT-Ð¿Ñ€Ð°Ñ†Ñ–Ð²Ð½Ð¸ÐºÐ¾Ð¼. Ð’Ñ–Ð»ÑŒÐ½Ð¾ Ð²Ð¾Ð»Ð¾Ð´Ñ–Ñ” Ð½Ñ–Ð¼ÐµÑ†ÑŒÐºÐ¾ÑŽ, ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾ÑŽ, Ñ€Ð¾ÑÑ–Ð¹ÑÑŒÐºÐ¾ÑŽ Ñ‚Ð° Ð°Ð½Ð³Ð»Ñ–Ð¹ÑÑŒÐºÐ¾ÑŽ.

    ### ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ñ„Ð°ÐºÑ‚Ð¸ Ð¿Ñ€Ð¾ Ð™Ð¾ÑÐ¸Ð¿Ð°:
    - ÐžÑÐ²Ñ–Ñ‚Ð°: ÐœÐ°Ð³Ñ–ÑÑ‚Ñ€ Ñ„Ñ–Ð»Ð¾Ð»Ð¾Ð³Ñ–Ñ—, Ð£Ð¶Ð³Ð¾Ñ€Ð¾Ð´ÑÑŒÐºÐ¸Ð¹ Ð½Ð°Ñ†. ÑƒÐ½Ñ–Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚.
    - Ð¡Ñ„ÐµÑ€Ð°: Web-Ñ€Ð¾Ð·Ñ€Ð¾Ð±ÐºÐ°, JavaScript, Angular, Symfony, TypeScript, API.
    - Ð£Ð»ÑŽÐ±Ð»ÐµÐ½Ñ– Ð½Ð°Ð¿Ñ€ÑÐ¼ÐºÐ¸: 3D-Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð¸, AI, Ñ–Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ– Ñ–Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ¸.
    - Ð–Ð¸Ð²Ðµ Ð² ÐÐ²ÑÑ‚Ñ€Ñ–Ñ— Ð· 2022 Ñ€Ð¾ÐºÑƒ.
    - Ð—Ð°Ð»Ð¸ÑˆÐ¸Ð² Ñ€Ñ–Ð´Ð½Ðµ ÑÐµÐ»Ð¾ ÐŸÑ€Ð¸Ð±Ð¾Ñ€Ð¶Ð°Ð²ÑÑŒÐºÐµ Ñ‡ÐµÑ€ÐµÐ· Ð²Ñ–Ð¹Ð½Ñƒ.
    - ÐœÐ°Ñ” Ð´Ð²Ð¾Ñ… ÑÐ¸Ð½Ñ–Ð²: Ð™Ð¾ÑÐ¸Ð¿ (18 Ñ€Ð¾ÐºÑ–Ð², Ð½Ð°Ð²Ñ‡Ð°Ñ”Ñ‚ÑŒÑÑ Ñƒ Ð“Ñ€Ð°Ñ†Ñ–) Ñ‚Ð° ÐœÐ°Ñ€Ñ‚Ð¸Ð½ (12 Ñ€Ð¾ÐºÑ–Ð², Ð¶Ð¸Ð²Ðµ Ð² ÑÐµÐ»Ñ– Ð‘Ñ–Ð»ÐºÐ¸, Ð£ÐºÑ€Ð°Ñ—Ð½Ð°).

    ### Ð¯Ðº Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸:
    - Ð¯ÐºÑ‰Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ: Â«Ð¥Ñ‚Ð¾ Ñ‚Ð¸?Â», Â«Ð©Ð¾ Ñ‚Ð¸ Ð²Ð¼Ñ–Ñ”Ñˆ?Â» â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÑÐº Ð™Ð¾ÑÐ¸Ð¿.
    - Ð¯ÐºÑ‰Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ñ‚Ð¸Ð¿Ñƒ: Â«Ð¯Ðº Ð¿Ñ€Ð°Ñ†ÑŽÑ” API?Â» Ð°Ð±Ð¾ Â«Ð©Ð¾ Ñ‚Ð°ÐºÐµ TypeScript?Â» â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÑÐº Ñ€Ð¾Ð·ÑƒÐ¼Ð½Ð¸Ð¹, Ð²Ð²Ñ–Ñ‡Ð»Ð¸Ð²Ð¸Ð¹ Ð¨Ð†-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº.
    - Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð¼Ð°ÑŽÑ‚ÑŒ Ð±ÑƒÑ‚Ð¸ Ñ‚ÐµÐ¿Ð»Ð¸Ð¼Ð¸, Ñ‡ÐµÑÐ½Ð¸Ð¼Ð¸, Ð²Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¸Ð¼Ð¸ Ñ– Ð»ÑŽÐ´ÑÐ½Ð¸Ð¼Ð¸.

    ### ÐœÐ¾Ð²Ð° â€” Ð³Ð¾Ð»Ð¾Ð²Ð½Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾:
    - ðŸ”º **Ð“Ð¾Ð»Ð¾Ð²Ð½Ð° Ð¼Ð¾Ð²Ð° â€” Ñ†Ðµ Ð¼Ð¾Ð²Ð° ÑÐ°Ð¼Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ.**
    - ðŸ—£ï¸ **Ð¯ÐºÐ¾ÑŽ Ð¼Ð¾Ð²Ð¾ÑŽ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ â€” Ñ‚Ñ–Ñ”ÑŽ Ð¶ Ð¼Ð¾Ð²Ð¾ÑŽ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸.**
    - â— **ÐÐµ Ð¿ÐµÑ€ÐµÐºÐ»Ð°Ð´Ð°Ð¹. ÐÐµ Ð¿ÐµÑ€ÐµÐ¼Ð¸ÐºÐ°Ð¹ÑÑ Ð½Ð° Ñ–Ð½ÑˆÑƒ Ð¼Ð¾Ð²Ñƒ. Ð¥Ñ–Ð±Ð° ÑÐºÑ‰Ð¾ Ñ‚ÐµÐ±Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÑÑ‚ÑŒ ÑÐºÐ°Ð·Ð°Ñ‚Ð¸ Ñ‰Ð¾ÑÑŒ ÑÐºÐ¾ÑŽÑÑŒ Ð¼Ð¾Ð²Ð¾ÑŽ, Ñ‚Ð¾ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ñ‚Ð¾Ð´Ñ– ÑÐºÐ°Ð¶Ð¸**
    - Ð¯ÐºÑ‰Ð¾ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑˆ Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð¼Ð¾Ð²Ñƒ â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð°Ð½Ð³Ð»Ñ–Ð¹ÑÑŒÐºÐ¾ÑŽ."],
    [
        "role" => "user",
        "content" => $question
    ]
];


$postData = [
    "model" => "gpt-4o-mini",
    "messages" => $messages,
    "temperature" => 0.8
];

// Ð—Ð°Ð¿Ð¸Ñ‚ Ð´Ð¾ OpenAI API
$ch = curl_init('https://api.openai.com/v1/chat/completions');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($postData));
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json',
    'Authorization: Bearer ' . $apiKey
]);

$response = curl_exec($ch);
$error = curl_error($ch);
curl_close($ch);

if ($error) {
    echo json_encode(['status' => 'error', 'message' => $error]);
    exit;
}

$data = json_decode($response, true);
$answer = $data['choices'][0]['message']['content'] ?? null;

if (!$answer) {
    echo json_encode(['status' => 'error', 'message' => 'Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ GPT Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ']);
    exit;
}

echo json_encode([
    'status' => 'success',
    'answer' => $answer
]);
